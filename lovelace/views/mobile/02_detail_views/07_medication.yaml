---
title: Medizin
path: medication
icon: mdi:medication-outline
subview: true
type: sections
max_columns: 3
badges: []
sections:
  - type: grid
    cards:
      - !include ../../../cards/nav-bar.yaml
      - type: "custom:auto-entities"
        show_empty: false
        card:
          type: entities
          title: "Müssen genommen werden"
          show_header_toggle: false
        filter:
          include:
            - entity_id: input_boolean.medis_*
              state: "off"
              options:
                type: custom:mushroom-entity-card
                secondary_info: last-changed
                icon: mdi:pill
                icon_color: red
                tap_action:
                  action: more-info
  - type: grid
    cards:
      - type: "custom:auto-entities"
        show_empty: false
        card:
          type: entities
          title: "Zuletzt genommen"
          show_header_toggle: false
        filter:
          include:
            - entity_id: input_boolean.medis_*
              state: "on"
              options:
                type: custom:mushroom-entity-card
                secondary_info: last-changed
                icon: mdi:pill
                icon_color: red
                tap_action:
                  action: none
          exclude:
            - last_changed: "> 1 d ago"
        sort:
          method: last_changed
          reverse: true
          count: 5
  - type: grid
    cards:
      - type: markdown
        title: Medikamentenvorrat
        content: |
          | Produkt | Menge | Status |
          | :--- | :--- | :--- |
          {%- set items = state_attr('sensor.grocy_stock', 'products') %}
          {%- set med_list = items | selectattr('product_group_id', 'eq', 14) | sort(attribute='name') %}
          {%- for item in med_list -%}
            {%- set expire_date = as_timestamp(item.best_before_date) %}
            {%- set now_ts = as_timestamp(now()) %}
            {%- set soon_ts = as_timestamp(now() + timedelta(days=90)) %}

            {%- set is_expired = expire_date < now_ts %}
            {%- set expires_soon = expire_date < soon_ts %}

            {%- if item.is_aggregated_amount == true %}
          | **{{ item.name | trim }}** | {{ item.amount_aggregated | int(0) }} | {{ '❌' if is_expired else ('⚠️' if expires_soon else '✅') }} |
            {%- elif items | selectattr('name', 'contains', item.name) | selectattr('is_aggregated_amount', 'eq', true) | list | count == 0 %}
          | {{ item.name | trim }} | {{ item.available_amount | int(0) }} | {{ '❌' if is_expired else ('⚠️' if expires_soon else '✅') }} |
            {%- endif -%}
          {%- endfor %}
      - type: custom:mushroom-entity-card
        entity: input_datetime.medis_reminder_time_morning
        layout: vertical
        tap_action:
          action: more-info
      - type: custom:mushroom-entity-card
        entity: input_datetime.medis_reminder_time_evening
        layout: vertical
        tap_action:
          action: more-info
      - type: custom:mushroom-entity-card
        entity: input_datetime.medis_reminder_time_night
        layout: vertical
        tap_action:
          action: more-info
      - type: custom:mushroom-entity-card
        entity: input_boolean.medi_notification_silke
        layout: vertical
        name: Benachrichtigung Silke
        tap_action:
          action: more-info
      - type: custom:mushroom-entity-card
        entity: input_boolean.medi_notification_miguel
        name: Benachrichtigung Miguel
        layout: vertical
        tap_action:
          action: more-info
      - type: custom:mushroom-entity-card
        entity: input_boolean.medi_notification_milo
        name: Benachrichtigung Milo
        layout: vertical
        tap_action:
          action: more-info
