---
#
timer_badge_template:
  default:
    icon: mdi:timer-sand
  card:
    type: custom:entity-progress-badge-template
    entity: "[[entity]]"
    icon: "[[icon]]"
    bar_effect: shimmer
    percent: >
      {% if states(entity) == 'active' %}
        {% set end = state_attr(entity, 'finishes_at') | as_datetime(default=None) %}
      {% else %}
        {% set end = states(entity) | as_datetime(default=None) %}
      {% endif %}
      {% set start = states[entity].last_changed | as_datetime(default=None) %}
      {% if end and start %}
        {% set total = (end - start).total_seconds() %}
        {% set elapsed = (now() - start).total_seconds() %}
        {% if total > 0 %}
          {% set progress = (elapsed / total * 100) | round(1) %}
          {{ [0, [progress, 100] | min] | max }}
        {% else %}
          0
        {% endif %}
      {% else %}
        0
      {% endif %}
    min_value: 0
    max_value: 100
    unit: "%"
    name: >
      {% if states(entity) == 'active' %}
        {% set end = state_attr(entity, 'finishes_at') | as_datetime(default=None) %}
      {% else %}
        {% set end = states(entity) | as_datetime(default=None) %}
      {% endif %}
      {% if end %}
        {% set remaining = (end - now()).total_seconds() %}
        {% if remaining <= 0 %}
          ğŸŸ¢ Fertig
        {% elif remaining < 60 %}
          â±ï¸ Noch {{ remaining | round(0) }} s
        {% elif remaining < 3600 %}
          â±ï¸ Noch {{ (remaining // 60) | int }} min {{ (remaining % 60) | int }} s
        {% else %}
          â±ï¸ Noch {{ (remaining // 3600) | int }} h {{ ((remaining % 3600) // 60) | int }} min
        {% endif %}
      {% else %}
        Kein Timer aktiv
      {% endif %}
