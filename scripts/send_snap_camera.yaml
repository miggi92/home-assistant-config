---
# Make snapshots of camera and send it
send_cam_snaps:
  icon: mdi:camera
  alias: "Snapshots von Kameras senden"
  sequence:
    - variables:
        camera_configs:
          - camera: "camera.flurcam"
            switch: "switch.flur_cam_stecker"
          - camera: "camera.korbchen"
            switch: "switch.kamera_steckdose_wz"
        start_time: "{{ now() }}"
    - repeat:
        for_each: "{{ camera_configs }}"
        item: "cam"
        sequence:
          - if:
              - condition: template
                value_template: "{{ is_state(cam.switch, 'on') }}"
            then:
              - variables:
                  friendly_name: "{{ state_attr(cam.camera, 'friendly_name') }}"
                  file_name: >
                    {{ friendly_name | replace(' ', '_') }}_{{ now().strftime('%Y%m%d-%H%M%S') }}.jpg
                  full_path: "/config/www/cams/{{ file_name }}"
                  web_path: "/local/cams/{{ file_name }}"

              - action: camera.snapshot
                target:
                  entity_id: "{{ cam.camera }}"
                data:
                  filename: "{{ full_path }}"

              - event: cam_event
                event_data:
                  event: "Cam check"
                  starts: "{{ start_time }}"
                  ends: "{{ now() }}"
                  summary: "Aktuelles Kamerabild"
                  key_frame: "{{ web_path }}"
                  camera: "{{ cam.camera }}"

              - action: script.notify_engine
                data:
                  title: "ðŸ“¹ {{ friendly_name }} ðŸ“¹"
                  value1: "Aktuelles Bild"
                  who: "home"
                  tag_id: "information"
                  photo:
                    path: "{{ full_path }}"
                    caption: "{{ friendly_name }}"
