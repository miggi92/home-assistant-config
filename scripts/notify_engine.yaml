---
#####
# Notifications engine - adapted from CCOSTAN
# Original Repo : https://github.com/CCOSTAN/Home-AssistantConfig
#####
notify_engine:
  alias: "NotifyEngine"
  icon: mdi:bell-ring
  description: "Notification engine."
  fields:
    title:
      selector:
        text: null
      name: Title
      description: Title of the notification
      required: true
    value1:
      selector:
        text:
          multiline: true
      name: Message part 1
      description: Notification content part 1
      required: true
    value2:
      selector:
        text:
          multiline: true
      name: Message part 2
      description: Notification content part 2
    value3:
      selector:
        text:
          multiline: true
      name: Message part 3
      description: Notification content part 3
    who:
      selector:
        text:
          multiline: true
      default: home
      name: Who
      description: Who should the notification go to? (Comma-separated for multiple recipients)
    photo:
      selector:
        text: null
      name: Foto
      description: Photo URL
    group:
      selector:
        text: null
      name: Group
      description: Group
    tag_id:
      selector:
        select:
          options:
            - information
            - alert
      default: information
      name: Tag
      description: Tag ID
    inline_keyboard:
      selector:
        object: null
      name: Inline keyboard
      description: Option to reply directly to messages
    actions:
      selector:
        object: null
      name: Actions
      description: Actions
    icon:
      selector:
        text: null
      name: Icon
      description: Icon

  mode: parallel
  sequence:
    - condition: state
      entity_id: input_boolean.text_notifications
      state: "on"
    - variables:
        channel_services:
          home: notify.telegram_bot_home
          sig_home: notify.signalhome
          mobile_app_miguel: notify.mobile_app_pixel_9_pro
          telegram_miguel: notify.telegram_bot_miguel
          mobile_app_silke: notify.mobile_app_sm_s911b
          telegram_silke: notify.telegram_bot_silke
          work: notify.html5_work_laptop_hp
          tv: notify.gtv
          tv_overlay: notify.tvoverlaynotify
          family: notify.signalfamily
        user_channel_selectors:
          miguel: input_select.miguel_notification_channel
          silke: input_select.silke_notification_channel
        recipient_list: "{{ (who | default('miguel')).split(',') | map('trim') | list }}"
        message: "{{ value1 }} {{ value2 }} {{ value3 }}"
        telegram_chatids:
          home: !secret telegram_home_group
          telegram_miguel: !secret telegram_miguel
          telegram_silke: !secret telegram_silke
    - parallel:
        - repeat:
            for_each: "{{ recipient_list }}"
            sequence:
              - condition: template
                alias: "Check if recipient's notifications are muted"
                value_template: >
                  {% set recipient = repeat.item %}
                  {% set muteSwitch = 'input_boolean.notifications_' ~ recipient %}

                  {% if recipient in ['tv', 'tv_overlay', 'work', 'home', 'sig_home', 'family'] %}
                    true
                  {% elif states(muteSwitch) is not none %}
                    {{ is_state(muteSwitch, 'on') }}
                  {% else %}
                    true
                  {% endif %}
              - variables:
                  recipient: "{{ repeat.item }}"
                  notifier: >
                    {% set selector = user_channel_selectors.get(recipient) %}

                    {% if selector %}
                      {% set selected_channel = states(selector) %}
                      {{ channel_services.get(selected_channel) | default('notify.miguel_telegram') }}
                    {% else %}
                      {{ channel_services.get(recipient) | default('notify.miguel_telegram') }}
                    {% endif %}
                  chatid: "{{ telegram_chatids.get(recipient) }}"
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ 'telegram' in notifier }}"
                    sequence:
                      - if:
                          - condition: template
                            value_template: "{{ photo is defined }}"
                        then:
                          - action: telegram_bot.send_photo
                            data:
                              verify_ssl: false
                              config_entry_id: 01JZ6NS8C75P2K898VAJVFV86K
                              caption: "{{ photo.caption }}"
                              file: "{{ photos.path }}"
                              target:
                                - "{{ chatid }}"
                        else:
                          - action: notify.send_message
                            target:
                              entity_id: "{{ notifier }}"
                            data:
                              message: "{{ message | replace('.', '\\.') }}"
                              title: "{{ title }}"
                  - conditions:
                      - condition: template
                        value_template: "{{ who == 'tv' }}"
                    sequence:
                      - action: "{{ notifier }}"
                        alias: "Send Notification to TV"
                        data:
                          title: "{{ title  }}"
                          message: "{{ message }}"
                          data:
                            image:
                              url: "{{ photo.path }}"
                  - conditions:
                      - condition: template
                        value_template: "{{ 'signal' in notifier }}"
                    sequence:
                      - action: "{{ notifier }}"
                        alias: "Signal notification "
                        data:
                          message: >-
                            **{{ title }}**

                            {{ message }}
                          data: >
                            {% set data = {} %}
                            {% set data = dict(data, **{'text_mode': 'styled'}) %}
                            {% if photo %}
                              {% set data = dict(data, **{'attachments': [photo]}) %}
                            {% endif %}
                            {{ data }}
                  - conditions:
                      - condition: template
                        value_template: "{{ who == 'tv_overlay' }}"
                    sequence:
                      - action: notify.tvoverlaynotify
                        data:
                          title: "{{ title }}"
                          message: "{{ message }}"
                          data:
                            appTitle: "{{ group }}"
                            seconds: 15
                            image: "{{ photo.path }}"
                default:
                  - variables:
                      notification_payload: >
                        {% set d = namespace(data={}) %}
                        {% if group is defined and group %}
                          {% set d.data = dict(d.data, group=group) %}
                        {% endif %}
                        {% if tag_id is defined and tag_id %}
                          {% set d.data = dict(d.data, tag=tag_id) %}
                        {% endif %}
                        {% if icon is defined and icon %}
                          {% set d.data = dict(d.data, notification_icon=icon) %}
                        {% endif %}
                        {% if photo is defined and photo %}
                          {% set d.data = dict(d.data, image=photo.path) %}
                        {% endif %}
                        {% if actions is defined and actions %}
                          {% set d.data = dict(d.data, actions=actions) %}
                        {% endif %}
                        {{ d.data }}

                  - action: "{{ notifier }}"
                    alias: "Default notification"
                    data:
                      title: "{{ title }}"
                      message: "{{ message }}"
                      data: "{{ notification_payload }}"
        - alias: "Duplicate notification logic"
          sequence:
            - condition: template
              value_template: "{{ who != 'tv' and who != 'work' and who != 'tv_overlay' }}"
            - variables:
                duplications:
                  - who: tv
                    condition: "{{ who != 'tv' }}"
                    device: device_tracker.gtv
                    media_check: media_player.gtv
                  - who: work
                    condition: "{{ who != 'work' }}"
                    device: device_tracker.bcwmc5cg4100cy0
                  - who: tv_overlay
                    condition: "{{ who != 'tv_overlay' }}"
                    device: device_tracker.1und1_box
                    media_check: media_player.fernseher_im_wohnzimmer
            - repeat:
                for_each: "{{ duplications }}"
                sequence:
                  - if:
                      - condition: template
                        value_template: "{{ repeat.item.condition }}"
                      - condition: template
                        value_template: "{{ states(repeat.item.device) == 'home' }}"
                        alias: "Check if device is home"
                      - condition: and
                        conditions:
                          - condition: template
                            value_template: "{{ repeat.item.media_check != '' }}"
                            alias: "Check if mediaplayer is defined"
                          - condition: template
                            value_template: "{{ states(repeat.item.media_check) != 'unavailable' }}"
                            alias: "Mediaplayer is not unavailable"
                          - condition: template
                            value_template: "{{ states(repeat.item.media_check) != 'off' }}"
                            alias: "Mediaplayer is not off"
                    then:
                      - action: script.notify_engine
                        data:
                          title: "{{ title }}"
                          value1: "{{ value1 }}"
                          value2: "{{ value2 }}"
                          value3: "{{ value3 }}"
                          who: "{{ repeat.item.who }}"
                          group: "{{ group }}"
                          photo: "{{ photo }}"
                          tag_id: "{{ tag_id }}"
